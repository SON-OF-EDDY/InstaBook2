{%extends 'base.html'%}

{% block content%}

    {%if user.is_authenticated %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>



                <style>
                

                #clickableAwesomeFont {
                    cursor: pointer;


                }

                #to-top {
                    cursor: pointer;
                    position: fixed;
                    right: 2.5%;
                    bottom: 2%;


                }




                </style>
<hr/>
                <h1>MY SONGS</h1>
<hr/>
                <br>
                <br>

                <span id='clickableAwesomeFont'><i id = 'changing-icon' class="fa-solid fa-circle-down fa-3x" style="color:#ffc008"></i>
                </span><span id='to-top'><i id = 'changing-icon2' class="fa-solid fa-circle-up fa-3x" style="color:#ffc008"></i>
                </span>


                <script>

                    function animate_icon2() {

                          var icon = document.getElementById('changing-icon2');

                          // change to 2
                          setTimeout(function () {
                            //console.log('stage 2');
                            icon.className = "fa-regular fa-circle-up fa-3x";
                          }, 125);

                          //back to 1
                          setTimeout(function () {
                          //console.log('back to 1');
                            icon.className = "fa-solid fa-circle-up fa-3x";
                          }, 250);

                     }

                    document.getElementById('to-top').onclick = function() {
                        animate_icon2();
                        setTimeout(function () {
                            window.scrollTo(0, 0);
                          }, 250);
                    };
</script>



                <br><br><h6><b>ADD SONG</b></h6>



                <script>

                    function animate_icon() {

                          var icon = document.getElementById('changing-icon');

                          // change to 2
                          setTimeout(function () {
                            icon.className = "fa-regular fa-circle-down fa-3x";
                          }, 125);

                          //back to 1
                          setTimeout(function () {
                            icon.className = "fa-solid fa-circle-down fa-3x";
                          }, 250);

                     }

                    document.getElementById('clickableAwesomeFont').onclick = function() {
                        animate_icon();
                        setTimeout(function () {
                            document.getElementById("scroll-location").scrollIntoView();
                          }, 250);
                    };

                </script>





<br>
<br>

<form id ='search-song' class="d-flex" role="search" method = 'POST'>
            {% csrf_token%}
          <input id ='song-input' name="song-input" class="form-control me-2" type="search" placeholder="Enter a song and/or artist..." aria-label="Search">
        <input type="hidden" name="user-id" id="user-id" value="{{current_user}}">
        <input type="submit" class="btn btn-warning" value="Search" name="search-button" id="search-button">
      </form>

<br>
<br>
<div id ='main-area'>
</div>
<br><br><br>

<h3>ALL SONGS:</h3>


<script>

                    $(document).on('submit',"form",function(e){


                            var oForm = $(this);
                            var formId = oForm.attr("id");


                            if (formId == 'search-song') {

                                console.log('search bar');

                                e.preventDefault();

                                var inputValue = oForm.find("input#song-input").val();
                                var secondValue = $(this).closest('form').find('input').eq(2).val();

                                console.log(`queryis: ${inputValue}`);
                                console.log(`user is: ${secondValue}`);


                                if (!(inputValue)=='') {

                                        console.log('query is not null');


                                        $.ajax({
                                                type:'POST',
                                                url:"{% url 'filter_songs'%}",
                                                data:{

                                                    song_name:inputValue,
                                                    user_name:secondValue,

                                                    csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
                                                },

                                                success: function(response){

                                                    console.log(response);
                                                    var size = response.filtered_song_list.length;
                                                    console.log(size);


                                                    // we gotta check here for the case of no results
                                                    // create our own div and put him in the document instead
                                                    // or just do nothing...


                                                    if (!(size==0)) {


                                                                        function tableCreate(row, col){

                                                                            if (document.getElementById('search-results')) {

                                                                                document.getElementById('search-results').remove();
                                                                                console.log("previous table deleted!");

                                                                            } else {

                                                                                console.log("there is no table yet!");
                                                                            }


                                                                            //gotta delete old DIVS here too LOL

                                                                            if (document.getElementById('no-results-box')) {

                                                                                document.getElementById('no-results-box').remove();
                                                                                console.log("previous DIV deleted!");

                                                                            } else {

                                                                                console.log("there is no div yet!");
                                                                            }


                                                                            let body = document.body;
                                                                            let tbl  = document.createElement('table');
                                                                            tbl.setAttribute("id", "search-results");
                                                                            tbl.setAttribute("class","table");

                                                                            let tr = tbl.insertRow();

                                                                            let header = ['Title and Artist','File'];

                                                                            var bold = document.createElement('strong');

                                                                            for(let j = 0; j < col; j++){
                                                                                        let td = tr.insertCell();
                                                                                        td.appendChild(document.createTextNode(`${header[j]}`));

                                                                                        //td.style.border = '1px solid black';
                                                                                        //td.style.borderColor = "black";
                                                                                        //td.style.backgroundColor = "white";
                                                                                        //td.style.color = 'black';
                                                                                        td.style.fontWeight = 'bold';
                                                                                        //td.style.border = '3px solid black';
                                                                                    }


                                                                            console.log("new table created");


                                                                            //tbl.style.width  = '1000px';
                                                                            //tbl.style.border = '3px solid black';

                                                                            for(let i = 0; i < row; i++){
                                                                                let tr = tbl.insertRow();

                                                                                for(let j = 0; j < col; j++){


                                                                                        let td = tr.insertCell();




                                                                                        td.innerHTML = `${response.filtered_song_list[i][j]}`;



                                                                                        //td.style.border = '3px solid black';
                                                                                        //td.style.width  = '500px';

                                                                                    }
                                                                            }

















                                                                            //body.appendChild(tbl);
                                                                            document.getElementById('main-area').appendChild(tbl);

                                                                        }

                                                                        tableCreate(size,1);

                                                    // this is the end of the if for SIZE
                                                    } else {

                                                        //gotta delete old divs too...

                                                        console.log('there are no results!!!!');

                                                        if (document.getElementById('no-results-box')) {

                                                            document.getElementById('no-results-box').remove();
                                                            console.log("previous DIV deleted!");

                                                        } else {

                                                            console.log("there is no div yet!");
                                                        }

                                                        // gotta delete the table if it exists here too...

                                                        if (document.getElementById('search-results')) {

                                                            document.getElementById('search-results').remove();
                                                            console.log("previous table deleted!");

                                                        } else {

                                                            console.log("there is no table yet!");
                                                        }


                                                        var box = document.createElement("div");


                                                        box.setAttribute("id","no-results-box");
                                                        box.innerHTML = `Sorry, no results found for '${inputValue}' !`;
                                                        box.style.fontWeight = 'bold';
                                                        document.getElementById('main-area').appendChild(box);
                                                        //document.getElementById().appendChild(box);

                                                    }


                                                // this is the end of the success function
                                                }














                                            //end of ajax
                                            });




                                //end of if query is null
                                } else {
                                    //gotta delete any old tables from before if exist...
                                    console.log(" query is null!!!");

                                    if (document.getElementById('search-results')) {

                                        document.getElementById('search-results').remove();
                                        console.log("previous table deleted!");

                                    } else {

                                        console.log("there is no table yet!");
                                    }


                                    //gotta delete old DIVS too

                                    if (document.getElementById('no-results-box')) {

                                        document.getElementById('no-results-box').remove();
                                        console.log("previous DIV deleted!");

                                    } else {

                                        console.log("there is no div yet!");
                                    }


                                }

                            }

                    });
                </script>








                <br>

                    {%if show_table %}
                       <br>
                        <br>

                    <table class="table">

                    <thead class="thead-dark">

                    <tr>

                      <th scope="col"></th>



                    </tr>

                  </thead>

                  <tbody>

                      {%for entry in entries%}

                          {%if current_user == entry.author %}

                          <tr>

                              <td style="word-break:break-all;"><b>Title:</b><br>
                                  {{entry.title}}
                                  <br>
                                  <br>
                                  <b>Artist:</b>
                                  <br>
                                  {{entry.artist}}

                                    <br><br>

                                  <audio id ='my-audio{{entry.id}}' controls style="width: 300px;">
                                    <source src="{{entry.song_file.url}}" type="audio/mp3">
                                    </audio>

                                  <script>

                                            function detectMob() {
                                                const toMatch = [
                                                    /Android/i,
                                                    /webOS/i,
                                                    /iPhone/i,
                                                    /iPad/i,
                                                    /iPod/i,
                                                    /BlackBerry/i,
                                                    /Windows Phone/i
                                                ];

                                                return toMatch.some((toMatchItem) => {
                                                    return navigator.userAgent.match(toMatchItem);
                                                });
                                            }


                                            if (detectMob()) {

                                                document.getElementById('my-audio'+{{entry.id}}).style["max-width"] = '300px';

                                            } else {

                                                document.getElementById('my-audio'+{{entry.id}}).style["max-width"] = '300px';
                                            }


                                        </script>


                                  <br>
                                  <br>

                                  <button type="button" class="btn btn-outline-warning" data-toggle="modal" data-target="#{{entry.id}}">
                            Delete Song
                                  </button>
                                  <br><br>

                           <div class="modal fade" id="{{entry.id}}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalLabel">WARNING</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                  <span aria-hidden="true">&times;</span>
                                                </button>
                                              </div>
                                              <div class="modal-body">
                                                Are you sure you want to delete this song?
                                              </div>
                                                <div class="modal-footer">

                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>

                                                  <a  href="{%url 'delete_song' entry.id%}" class="btn btn-outline-warning">Yes</a>

                                                </div>
                                </div>
                              </div>
                            </div>

                          <a  href="{%url 'edit_song' entry.id%}" class="btn btn-warning">Edit Song</a>











                              </td>




                          </tr>

                          {%endif%}

                      {%endfor%}

                  </tbody>
                </table>

                    {%else%}
<br>


<div class="card mb-3" style="max-width: 540px;">
                  <div class="row g-0">


<div class="col-md-8">
                      <div class="card-body">


                          <p style="font-size:24px;" class="card-text"><h4>You have no saved music!</h4></p>



                      </div>
                    </div>
                  </div>
                </div>






                  {%endif%}


                <br>
                <br>
<br>
<br>
<hr/>

                <h1 id="scroll-location">ADD A SONG</h1>
<hr/>
                <br>
                <br>

                <form action="{%url 'add_song'%}" method="POST" enctype="multipart/form-data">

                    {% csrf_token%}

                    {{form.as_p}}

                    <button type="submit" class="btn btn-warning">Add</button>
                    <br>
                    <br>
                    <br>
                    <br>

                </form>

{%else%}
    <h2>You must be logged in to view this page.</h2>


{%endif%}


{%endblock%}
